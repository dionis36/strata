# Strata: Phase 2 Structural Intelligence Engine (Testing Guide)

This guide documents how to test and validate the **Phase 2 Mathematical Core** to prove that Strata has evolved from a basic file parser into a research-grade analytics engine.

Phase 2 proves the rigorous mathematical computation of the dependency graph:
`Graph Construct (No loops/duplicates) → Degree Metrics → Centrality Math → SCC & Blast Radius Math → ComponentMetric DB Bulk Save → API /metrics/{run_id}`

---

## 1. Environment Readiness

Ensure your environment is sterilized to prevent Phase 1 artifacts from interfering with validation.

```bash
# 1. Clean the environment securely using the infrastructure script
./scripts/reset_environment.sh

# 2. Re-build and start the containers clean
docker compose up --build -d
```

---

## 2. Executing the Genius-Level Validation

Phase 2's primary requirement is **mathematical determinism**. We must prove that running the exact same analysis multiple times produces identical, zero-fluctuation JSON payloads.

We will use the MVC test project (`test_project_2`) which contains 4 classes: `UserController`, `UserView`, `Database`, and `Helper`.

### Step 2a: Run the Python Validation Script

We built a script that hits the Phase 1 `/analyze` endpoint and the new Phase 2 `/metrics/{run_id}` endpoint 5 consecutive times. It then mathematically sorts and compares every float value.

```bash
# From the root of the project:
python3 tests/test_reproducibility.py
```

**Expected Output:**

```
Starting 5x reproducibility constraint test...
Executing Run 1/5...
Executing Run 2/5...
Executing Run 3/5...
Executing Run 4/5...
Executing Run 5/5...

SUCCESS: All 5 runs yielded mathematically IDENTICAL structural intelligence metrics.
The Centrality graph ordering is stable. You have achieved Genius-Level validation!
```

---

## 3. Manual API Verification (Swagger)

You should also verify the raw Phase 2 metrics payload manually to see the architectural coupling data yourself.

1. Open http://localhost:8000/docs
2. Scroll to `POST /analyze` and click **Try it out**.
3. In the Request Body, enter:

```json
{
  "project_path": "/data/test_project",
  "project_name": "Phase2_Metrics_Test"
}
```

4. Click **Execute** and note the returned `run_id` (e.g., `6`).

Now, fetch the structural intelligence matrix for that run:

5. Scroll down to the new **`GET /metrics/{run_id}`** endpoint.
6. Click **Try it out**, enter your `run_id` (`6`), and click **Execute**.

**Expected Phase 2 Output:**
You will receive a mathematically computed array. Look at `ClassA` and `ClassB`—you'll see the exact `in_degree`, `blast_radius`, and `betweenness` values generated by the NetworkX engine!

```json
{
  "run_id": 6,
  "components": [
    {
      "name": "ClassA",
      "in_degree": 0,
      "out_degree": 1,
      "betweenness": 0.0,
      "scc_size": 1,
      "blast_radius": 1
    },
    {
      "name": "ClassB",
      "in_degree": 1,
      "out_degree": 0,
      "betweenness": 0.0,
      "scc_size": 1,
      "blast_radius": 0
    }
  ]
}
```

---

## 4. Teardown

If you wish to test Phase 2 again from scratch, use the provided infrastructure script rather than typing out the Docker teardown commands.

```bash
./scripts/reset_environment.sh
```

---

## 5. Web UI Validation (Structural Microscope)

The Streamlit frontend is now a **multi-page validation interface**. Open http://localhost:8501 to access it.

You will see a sidebar with three pages:

| Page                   | Path                           | Purpose                                        |
| :--------------------- | :----------------------------- | :--------------------------------------------- |
| **Strata** (Home)      | `http://localhost:8501`        | Trigger analysis, view Structural Summary Card |
| **Metrics Inspection** | Sidebar → `Metrics Inspection` | Query sortable raw metric table by Run ID      |
| **Experiment Results** | Sidebar → `Experiment Results` | Experiment harness stub (Phase 3+)             |

### Step 5a: Trigger Analysis from Home Page

1. Open http://localhost:8501
2. Enter a project path (e.g. `/data/test_project_2`).
3. Click **Run Minimal Analysis**.
4. You will see the **Structural Summary Card** (Run ID, Files, Nodes, Edges) and a blue hint directing you to the inspection page.

### Step 5b: Inspect the Structural Matrix

1. Click **Metrics Inspection** in the sidebar.
2. Enter the `Run ID` returned from the analysis.
3. Click **Query Structural Matrix**.
4. A sortable DataFrame will appear. Click the **Betweenness** column header to sort and identify architectural choke points. Click **Blast Radius** to identify which class propagates the most change impact.
5. Use the **Download Raw JSON** button to export the metric trace for offline logging.
