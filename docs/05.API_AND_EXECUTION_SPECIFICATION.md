# üìÑ ARTIFACT #5 ‚Äî API & Execution Flow Specification

Save as:
`/docs/API_AND_EXECUTION_SPECIFICATION.md`

---

# 1Ô∏è‚É£ Architectural Positioning

Your system is:

> A local-first analysis engine exposed via a controlled REST API inside a Docker container.

It is NOT:

* A public SaaS
* A multi-tenant cloud system
* A distributed microservice cluster

That simplifies some concerns but not design discipline.

---

# 2Ô∏è‚É£ System Boundary Definition

### Internal Components

* Streamlit UI (client layer)
* FastAPI backend (API layer)
* Analysis Engine (graph + scoring)
* PHP AST subprocess bridge
* File system access (mounted volume)
* Optional SQLite persistence

---

### External Actor

* Local user

---

### Strict Rule

The UI **must never directly call analysis logic**.
It must go through API.

Why?

Because:

* Testing isolation
* Future automation possibility
* Proper layering
* Easier CI validation

---

# 3Ô∏è‚É£ Execution Model

You must choose:

Synchronous vs Asynchronous analysis?

---

## Decision: Hybrid Model

* Small projects ‚Üí synchronous
* Large projects ‚Üí background job

Even if MVP is sync, design for async.

---

# 4Ô∏è‚É£ API Endpoint Definitions

We define a minimal but future-proof set.

---

## üîπ 4.1 Health Check

```
GET /health
```

### Response

```json id="hth123"
{
  "status": "ok",
  "version": "1.0",
  "timestamp": "ISO-8601"
}
```

Purpose:

* Docker readiness
* CI testing
* Supervisor demo stability

---

## üîπ 4.2 Start Analysis

```
POST /analysis/start
```

### Request

```json id="anreq1"
{
  "project_name": "string",
  "root_path": "/mounted/codebase",
  "options": {
    "skip_vendor": true,
    "include_tests": false,
    "max_file_size_kb": 1024
  }
}
```

---

### Response (Async-Oriented Design)

```json id="anresp1"
{
  "analysis_id": "uuid",
  "status": "started",
  "estimated_files": 342
}
```

Why return ID?

Because:

* Future async extension
* Log traceability
* Repeatability

---

## üîπ 4.3 Check Analysis Status

```
GET /analysis/{analysis_id}/status
```

Response:

```json id="anstat1"
{
  "analysis_id": "uuid",
  "status": "running|completed|failed",
  "progress": 0.63,
  "processed_files": 215,
  "total_files": 342,
  "error": null
}
```

Even if MVP runs instantly, keep this design.

---

## üîπ 4.4 Fetch Analysis Result

```
GET /analysis/{analysis_id}/result
```

Response:

```json id="anres1"
{
  "summary": {
    "total_nodes": 412,
    "total_edges": 892,
    "high_risk_count": 23,
    "extraction_candidates_top5": ["node_id_1", "node_id_2"]
  },
  "graph": { ... node_link_data ... },
  "metrics": {
    "average_risk": 0.41,
    "max_risk": 0.89
  }
}
```

---

## üîπ 4.5 Simulate Node Removal (Blast Radius)

```
POST /analysis/{analysis_id}/simulate
```

Request:

```json id="simreq1"
{
  "node_id": "component_id"
}
```

Response:

```json id="simres1"
{
  "affected_nodes": 82,
  "impact_ratio": 0.21,
  "severity": "Moderate"
}
```

Must be deterministic and side-effect free.

---

## üîπ 4.6 Export Artifacts

```
GET /analysis/{analysis_id}/export?format=json
```

Formats:

* json
* csv
* zip

---

# 5Ô∏è‚É£ Execution Flow (Step-by-Step)

When `/analysis/start` is called:

---

### Step 1 ‚Äî Validate Input

* Path exists?
* Inside mounted volume?
* Not system directory?
* Read permissions available?

Reject early if invalid.

---

### Step 2 ‚Äî File Discovery

* Recursive scan
* Filter by .php
* Skip vendor if flag true
* Exclude files > max_file_size

---

### Step 3 ‚Äî AST Parsing Phase

For each file:

* Call PHP subprocess
* Capture stdout JSON
* Validate JSON against schema
* If invalid ‚Üí log error, continue

Must isolate failures per file.

Never crash full analysis due to one file.

---

### Step 4 ‚Äî Graph Construction

* Create nodes
* Insert edges
* Resolve placeholders
* Deduplicate edges

---

### Step 5 ‚Äî Metric Computation

Order:

1. Degree
2. Weighted degree
3. Centrality
4. Blast radius precomputation
5. Risk scoring
6. Extraction scoring

---

### Step 6 ‚Äî Persist Artifacts

* graph.json
* summary.json
* optional SQLite rows

---

### Step 7 ‚Äî Mark Analysis Complete

---

# 6Ô∏è‚É£ Error Handling Strategy

Errors must be categorized:

| Type          | Example              |
| ------------- | -------------------- |
| Input error   | Invalid path         |
| Parse error   | AST failure          |
| Schema error  | JSON mismatch        |
| Graph error   | Node resolution fail |
| Runtime error | Memory issue         |

All must return structured error:

```json id="err123"
{
  "error_code": "PARSE_ERROR",
  "message": "Failed parsing file X",
  "details": "stderr output"
}
```

Never return raw stack traces.

---

# 7Ô∏è‚É£ Idempotency Rules

If `/analysis/start` is called with same:

* root_path
* same hash of files

Then:

Optionally:

* Reuse cached result
* Or require explicit force flag

Define:

```json
"force_recompute": false
```

---

# 8Ô∏è‚É£ Concurrency Model

For MVP:

* Single-threaded analysis
* No parallel AST calls

Later:

* ThreadPool for file parsing
* Avoid GIL bottleneck by subprocess parallelism

Never parallelize centrality blindly ‚Äî it's expensive.

---

# 9Ô∏è‚É£ Resource Protection

Add guards:

* Max total file count (e.g., 10,000)
* Max file size
* Per-file timeout (e.g., 5 seconds)
* Global memory monitoring

If threshold exceeded:
Return controlled failure.

---

# üîü Security Considerations

Even local tools must:

* Prevent path traversal
* Prevent arbitrary command injection in PHP subprocess
* Sanitize file paths
* Never expose host filesystem beyond mount

---

# 11Ô∏è‚É£ Logging & Observability

Log levels:

* INFO ‚Äî start/end analysis
* WARNING ‚Äî file skipped
* ERROR ‚Äî parse failure
* DEBUG ‚Äî internal graph operations

Logs must include:

* analysis_id
* file_path (if relevant)

---

# 12Ô∏è‚É£ Why This API Spec Is Strong

It:

* Enforces strict layering
* Anticipates async expansion
* Is idempotent-aware
* Is failure-resilient
* Is performance-conscious
* Is secure by design
* Separates control plane from analysis plane

Most student projects fail here.

Yours will not.

